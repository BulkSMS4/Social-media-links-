<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Emergency Files ‚Äî Admin</title>
<style>
body { font-family: Arial,sans-serif; background:#0b0b0b; color:lime; padding:20px; }
h1 { color:#ff3333; text-align:center; margin-bottom:20px; }
.card { background:#111; padding:20px; border-radius:12px; max-width:800px; margin:0 auto; box-shadow:0 4px 12px rgba(0,0,0,0.7); }
.card label { display:block; margin-top:12px; font-weight:bold; color:#adff2f; }
.card input, .card textarea { width:100%; margin-bottom:12px; padding:12px; border-radius:8px; border:1px solid lime; background:#000; color:lime; box-sizing:border-box; font-size:16px; }
.card button { background:lime; color:black; font-weight:700; cursor:pointer; transition:0.2s; border-radius:6px; padding:6px 12px; font-size:14px; }
.card button:hover { background:#32cd32; }
.mask-link-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.mask-link-row input { flex:1; padding:12px; font-size:16px; }
.mask-link-row input.color-picker { width:50px; height:32px; padding:0; }
.mask-link-row button { padding:4px 8px; font-size:14px; }
.preview-area { border:1px solid lime; border-radius:8px; padding:12px; margin-top:12px; background:#111; color:#fff; font-size:14px; max-height:300px; overflow:auto; }
.post { background:#111; border-radius:12px; padding:12px; margin-bottom:12px; color:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.7); font-size:14px; }
.post a.download, .post a.install, .post a.open { display:inline-block; margin:4px 6px 4px 0; padding:6px 10px; border-radius:8px; font-weight:600; text-decoration:none; font-size:14px; }
.post a.download { background:#28a745; color:#fff; }
.post a.install { background:#007bff; color:#fff; }
.post a.open { background:#ff8c00; color:#fff; }
.post .deleteBtn { background:#ff3333; color:#fff; padding:6px 10px; border:none; border-radius:8px; cursor:pointer; font-size:14px; margin-left:6px; }
</style>
</head>
<body>

<h1>üõ†Ô∏è Upload Emergency Files</h1>
<div class="card">
  <label>File</label>
  <input type="file" id="fileInput" accept=".apk,.zip,.rar,.pdf,.html,image/*">

  <label>File Name (Optional)</label>
  <input type="text" id="fileName" placeholder="Display Name">
  <input type="color" id="fileNameColor" value="#ff3333">

  <label>Custom Masked Links (one per line)</label>
  <div id="maskedLinksContainer"></div>
  <button type="button" id="addMaskedLinkBtn">+ Add Masked Link</button>

  <label>Description (Optional)</label>
  <textarea id="fileDesc" placeholder="Warning or description"></textarea>

  <label>Post Background</label>
  <input type="color" id="fileBg" value="#111111">

  <div style="display:flex; gap:10px; justify-content:flex-start; margin-top:8px;">
    <button id="previewBtn">Preview</button>
    <button id="uploadBtn">Upload</button>
  </div>

  <div class="preview-area" id="previewArea">Preview will appear here...</div>
  <h3>Uploaded Files:</h3>
  <div id="uploadedFiles"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
  authDomain:"usahackersland.firebaseapp.com",
  projectId:"usahackersland",
  storageBucket:"usahackersland.appspot.com",
  messagingSenderId:"588407428267",
  appId:"1:588407428267:web:7c4898cbb62efd3d5953ee"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

const fileInput = document.getElementById('fileInput');
const fileNameInput = document.getElementById('fileName');
const fileNameColor = document.getElementById('fileNameColor');
const fileDescInput = document.getElementById('fileDesc');
const fileBgInput = document.getElementById('fileBg');
const uploadBtn = document.getElementById('uploadBtn');
const previewBtn = document.getElementById('previewBtn');
const previewArea = document.getElementById('previewArea');
const uploadedFilesDiv = document.getElementById('uploadedFiles');

const maskedLinksContainer = document.getElementById('maskedLinksContainer');
const addMaskedLinkBtn = document.getElementById('addMaskedLinkBtn');

function createMaskedLinkRow(url='', text='', color='#ff3333'){
  const row = document.createElement('div');
  row.className = 'mask-link-row';
  row.innerHTML = `
    <input type="text" class="maskUrl" placeholder="URL" value="${url}">
    <input type="text" class="maskText" placeholder="Masked Text" value="${text}">
    <input type="color" class="maskColor" value="${color}">
    <button type="button" class="deleteLinkBtn">X</button>
  `;
  row.querySelector('.deleteLinkBtn').addEventListener('click',()=>row.remove());
  maskedLinksContainer.appendChild(row);
}
addMaskedLinkBtn.addEventListener('click', ()=>createMaskedLinkRow());

function getFileType(fileName){
  const ext = fileName.split('.').pop().toLowerCase();
  if(ext==='apk') return 'apk';
  if(ext==='zip'||ext==='rar') return 'archive';
  if(ext==='pdf'||ext==='html'||ext==='htm'||ext==='jpg'||ext==='png'||ext==='jpeg'||ext==='gif') return 'open';
  return 'download';
}

function buildPostHTML(name,nameCol,desc,bg,url,maskedLinks,fileType){
  let html=`<div class="post" style="border:2px solid ${nameCol}; background:${bg}">
    <div class="meta">Admin | ${new Date().toLocaleString()}</div>
    <strong style="color:${nameCol}">${name}</strong><br>`;
  if(desc) html+=`<div style="color:${nameCol}">${desc}</div>`;
  maskedLinks.forEach(ml=>{
    html+=` <a href="${ml.url}" target="_blank" style="color:${ml.color}" class="download">‚¨á ${ml.text}</a>`;
  });
  if(fileType==='apk') html+=` <a href="${url}" target="_blank" class="install">Install</a> <a href="${url}" target="_blank" class="download">Download</a>`;
  else if(fileType==='archive') html+=` <a href="${url}" target="_blank" class="download">Download</a>`;
  else html+=` <a href="${url}" target="_blank" class="open">Open</a> <a href="${url}" target="_blank" class="download">Download</a>`;
  html+=` <button class="deleteBtn">Delete</button></div>`;
  return html;
}

previewBtn.addEventListener('click', ()=>{
  const file = fileInput.files[0];
  if(!file) return alert('Select file!');
  const name = fileNameInput.value || file.name;
  const nameCol = fileNameColor.value;
  const desc = fileDescInput.value;
  const bg = fileBgInput.value;
  const maskedLinks=[];
  maskedLinksContainer.querySelectorAll('.mask-link-row').forEach(r=>{
    const url=r.querySelector('.maskUrl').value;
    const text=r.querySelector('.maskText').value;
    const color=r.querySelector('.maskColor').value;
    if(url && text) maskedLinks.push({url,text,color});
  });
  const fileType = getFileType(file.name);
  previewArea.innerHTML = buildPostHTML(name,nameCol,desc,bg,'#',maskedLinks,fileType);
});

uploadBtn.addEventListener('click', ()=>{
  const file = fileInput.files[0];
  if(!file) return alert('Select file!');
  const name = fileNameInput.value || file.name;
  const nameCol = fileNameColor.value;
  const desc = fileDescInput.value;
  const bg = fileBgInput.value;

  const storageRef = storage.ref('emergencyFiles/'+Date.now()+'-'+file.name);
  storageRef.put(file).then(snap=>snap.ref.getDownloadURL()).then(url=>{
    const maskedLinks=[];
    maskedLinksContainer.querySelectorAll('.mask-link-row').forEach(r=>{
      const u=r.querySelector('.maskUrl').value;
      const t=r.querySelector('.maskText').value;
      const c=r.querySelector('.maskColor').value;
      if(u && t) maskedLinks.push({url:u,text:t,color:c});
    });
    const fileType = getFileType(file.name);
    return db.collection('emergencyFiles').add({name,nameCol,desc,bg,url,maskedLinks,fileType,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  }).then(()=>{
    fileInput.value='';fileNameInput.value='';fileDescInput.value='';maskedLinksContainer.innerHTML='';previewArea.innerHTML='';
    loadFiles();
  });
});

function loadFiles(){
  uploadedFilesDiv.innerHTML='Loading...';
  db.collection('emergencyFiles').orderBy('createdAt','desc').get().then(snap=>{
    uploadedFilesDiv.innerHTML='';
    snap.forEach(doc=>{
      const data=doc.data();
      const div = document.createElement('div');
      div.innerHTML = buildPostHTML(data.name,data.nameCol,data.desc,data.bg,data.url,data.maskedLinks,data.fileType);
      div.querySelector('.deleteBtn').onclick = ()=>doc.ref.delete().then(()=>loadFiles());
      uploadedFilesDiv.appendChild(div);
    });
  });
}

loadFiles();
</script>
</body>
</html>
