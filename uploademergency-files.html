<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Emergency Files â€” Admin</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #0b0b0b;
  color: #e0ffe0;
  padding: 25px;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  background: #111;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 0 15px rgba(0,255,0,0.2);
}
h1 {
  color: #00ff6a;
  text-align: center;
  margin-bottom: 20px;
}
label {
  display: block;
  margin-top: 10px;
  font-weight: 600;
  color: #adff2f;
}
input, textarea, select {
  width: 100%;
  padding: 10px;
  background: #000;
  color: #0f0;
  border: 1px solid #0f0;
  border-radius: 8px;
  font-size: 15px;
  box-sizing: border-box;
}
button {
  background: lime;
  color: #000;
  font-weight: bold;
  padding: 10px 14px;
  border: none;
  border-radius: 8px;
  margin-top: 10px;
  cursor: pointer;
}
button:hover { background: #00e600; }

.file-card {
  background: #151515;
  border: 1px solid #222;
  padding: 12px;
  border-radius: 10px;
  margin-top: 12px;
  color: #fff;
}
.file-card strong { color: #adff2f; }
.deleteBtn {
  background: #ff3333;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  margin-top: 8px;
  cursor: pointer;
}
.deleteBtn:hover { background: #ff0000; }

.progress {
  background: #333;
  border-radius: 8px;
  overflow: hidden;
  height: 10px;
  margin-top: 5px;
}
.progress-bar {
  height: 100%;
  width: 0%;
  background: lime;
  transition: width 0.3s;
}
.preview-images img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 8px;
  margin-right: 8px;
  border: 1px solid #333;
}
</style>
</head>
<body>
  <div class="container">
    <h1>ðŸ’» Upload Emergency Files</h1>
    <label>Select Files (PDF, ZIP, RAR, APK, etc.)</label>
    <input type="file" id="fileInput" multiple>

    <label>Upload Images (Icons, Screenshots, etc.)</label>
    <input type="file" id="imageInput" accept="image/*" multiple>

    <label>File Name (Optional)</label>
    <input type="text" id="fileName" placeholder="Display Name">

    <label>Custom Masked Link Text</label>
    <input type="text" id="maskedText" placeholder="e.g. Download / Install / Open">

    <label>Custom Color</label>
    <input type="color" id="customColor" value="#00ff6a">

    <label>Description</label>
    <textarea id="fileDesc" placeholder="Short description or warning"></textarea>

    <button id="uploadBtn">Upload All Files</button>
    <div id="uploadStatus"></div>

    <h2>Uploaded Files</h2>
    <div id="uploadedFiles"></div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
  authDomain: "x-cargo-exprees.firebaseapp.com",
  projectId: "x-cargo-exprees",
  storageBucket: "x-cargo-exprees.appspot.com",
  messagingSenderId: "1082201867958",
  appId: "1:1082201867958:web:d6600fbc82085b0b62c817",
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Cloudinary credentials
const cloudName = "dymwisuau";
const uploadPreset = "xportbox";

// Elements
const fileInput = document.getElementById("fileInput");
const imageInput = document.getElementById("imageInput");
const fileName = document.getElementById("fileName");
const maskedText = document.getElementById("maskedText");
const customColor = document.getElementById("customColor");
const fileDesc = document.getElementById("fileDesc");
const uploadBtn = document.getElementById("uploadBtn");
const uploadedFilesDiv = document.getElementById("uploadedFiles");
const uploadStatus = document.getElementById("uploadStatus");

// Upload to Cloudinary
async function uploadToCloudinary(file, onProgress) {
  const url = `https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`;
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", uploadPreset);

  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open("POST", url);
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        onProgress(percent);
      }
    };
    xhr.onload = () => {
      if (xhr.status === 200) resolve(JSON.parse(xhr.responseText));
      else reject(xhr.statusText);
    };
    xhr.onerror = () => reject("Upload failed");
    xhr.send(formData);
  });
}

// Upload process
uploadBtn.addEventListener("click", async () => {
  const files = Array.from(fileInput.files);
  if (files.length === 0) return alert("Select at least one file!");
  
  uploadStatus.innerHTML = `<p style="color:orange;">Uploading...</p>`;
  
  for (const file of files) {
    const progressBar = document.createElement("div");
    progressBar.className = "progress";
    const bar = document.createElement("div");
    bar.className = "progress-bar";
    progressBar.appendChild(bar);
    uploadStatus.appendChild(progressBar);

    try {
      const uploaded = await uploadToCloudinary(file, (percent) => bar.style.width = percent + "%");

      // Upload images
      const imageFiles = Array.from(imageInput.files);
      const imageUrls = [];
      for (const img of imageFiles) {
        const imgUpload = await uploadToCloudinary(img, () => {});
        imageUrls.push(imgUpload.secure_url);
      }

      const data = {
        name: fileName.value || file.name,
        desc: fileDesc.value,
        color: customColor.value,
        maskedText: maskedText.value || "Download",
        fileUrl: uploaded.secure_url,
        images: imageUrls,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection("emergencyFiles").add(data);
      uploadStatus.innerHTML = `<p style="color:lime;">âœ… Upload successful! It will appear on the dashboard.</p>`;
      loadFiles();
    } catch (err) {
      console.error(err);
      uploadStatus.innerHTML = `<p style="color:red;">Upload failed: ${err}</p>`;
    }
  }
});

// Load uploaded files
async function loadFiles() {
  uploadedFilesDiv.innerHTML = "";
  const snap = await db.collection("emergencyFiles").orderBy("createdAt", "desc").get();
  snap.forEach(doc => {
    const d = doc.data();
    const div = document.createElement("div");
    div.className = "file-card";
    div.innerHTML = `
      <strong style="color:${d.color}">${d.name}</strong><br>
      <span>${d.desc || ""}</span><br>
      <a href="${d.fileUrl}" target="_blank" style="color:${d.color};text-decoration:none;">â¬‡ ${d.maskedText}</a>
      <div class="preview-images">
        ${(d.images||[]).map(img=>`<img src="${img}">`).join('')}
      </div>
      <button class="deleteBtn" data-id="${doc.id}">Delete</button>
    `;
    div.querySelector(".deleteBtn").addEventListener("click", async () => {
      if (confirm("Delete this file?")) {
        await db.collection("emergencyFiles").doc(doc.id).delete();
        div.remove();
      }
    });
    uploadedFilesDiv.appendChild(div);
  });
}

loadFiles();
</script>
</body>
</html>
