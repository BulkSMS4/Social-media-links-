<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dynamic Form</title>
<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;color:#222;}
#formContainer{max-width:600px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;position:relative;}
.draggableBtn{position:absolute;cursor:move;color:#fff;border:none;border-radius:8px;}
.embedLink{margin-top:6px;padding:6px;background:#e8f0fe;border-radius:6px;}
input,textarea,select,button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
button.mainBtn{padding:10px;border:none;border-radius:8px;color:#fff;cursor:pointer;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<div id="formContainer"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
  authDomain: "usahackersland.firebaseapp.com",
  projectId: "usahackersland"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const $ = id => document.getElementById(id);
const formContainer = $("formContainer");

// Get form ID from URL
const urlParams = new URLSearchParams(window.location.search);
const formId = urlParams.get('id');

if(!formId){
  formContainer.innerHTML="<p>❌ Invalid form link</p>";
} else {
  db.collection("forms").doc(formId).get().then(doc=>{
    if(!doc.exists){
      formContainer.innerHTML="<p>❌ Form not found</p>";
      return;
    }
    const data = doc.data();
    renderForm(data);
  }).catch(err=>{
    console.error(err);
    formContainer.innerHTML="<p>❌ Error loading form</p>";
  });
}

function renderForm(data){
  formContainer.style.background = data.bgColor || "#fff";
  if(data.bgImageURL){
    formContainer.style.backgroundImage=`url(${data.bgImageURL})`;
    formContainer.style.backgroundSize=data.bgSize || "cover";
    formContainer.style.backgroundRepeat="no-repeat";
  }

  let html = "";
  if(data.avatarURL) html+=`<img src="${data.avatarURL}" style="width:90px;border-radius:50%;display:block;margin:auto">`;
  if(data.logoURL) html+=`<img src="${data.logoURL}" style="width:140px;display:block;margin:auto">`;
  html+=`<h2 style="text-align:center;color:${data.titleColor}">${data.title}</h2>`;
  html+=`<p style="text-align:center;color:${data.subtitleColor}">${data.subtitle}</p>`;
  html+=`<p>${data.description}</p>`;
  if(data.enableWarning && data.warningPosition!=="none"){
    html+=`<p style="color:#b71c1c;text-align:${data.warningPosition}">${data.warning}</p>`;
  }

  const formFields = document.createElement("div");
  formFields.style.display="flex";
  formFields.style.flexDirection="column";
  formFields.style.gap="8px";

  if(data.addAuth){
    formFields.innerHTML+=`<input placeholder="${data.usernamePlaceholder}">`;
    formFields.innerHTML+=`<input type="password" placeholder="${data.passwordPlaceholder}">`;
  }

  (data.extraFields||[]).forEach(f=>{
    if(f) formFields.innerHTML+=`<input placeholder="${f}">`;
  });

  // Embed links above main button
  (data.embedLinks||[]).forEach(link=>{
    if(!link.show) return;
    const div=document.createElement("div");
    div.className="embedLink";
    div.innerHTML=`<strong>${link.text}</strong>: <a href="${link.url}" target="_blank">${link.url}</a>`;
    if(link.desc) div.innerHTML+=`<br><small>${link.desc}</small>`;
    formFields.appendChild(div);
  });

  // Main Button
  if(data.showMainBtn){
    const mainBtn = document.createElement("button");
    mainBtn.className="mainBtn";
    mainBtn.style.background=data.btnColor;
    mainBtn.textContent=data.buttonText;
    mainBtn.onclick = () => {
      if(data.enableRedirect && data.redirectURL){
        window.location.href = data.redirectURL;
      } else {
        alert("Form submitted!");
      }
    };
    formFields.appendChild(mainBtn);
  }

  formContainer.appendChild(formFields);

  // Extra draggable buttons
  (data.extraButtons||[]).forEach(b=>{
    if(!b.show) return;
    const btn = document.createElement("button");
    btn.className="draggableBtn";
    btn.textContent=b.text;
    btn.style.background=b.color;
    btn.style.width=b.size+"px";
    btn.style.height=b.size+"px";
    btn.style.left=b.x+"%";
    btn.style.top=b.y+"%";
    btn.style.position="absolute";
    btn.onclick = ()=>window.open(b.link,"_blank");
    let dragging = false, offsetX=0, offsetY=0;
    btn.onmousedown = e => { dragging=true; offsetX=e.offsetX; offsetY=e.offsetY; };
    document.onmousemove = e => {
      if(!dragging) return;
      const rect=formContainer.getBoundingClientRect();
      let x=((e.clientX-rect.left-offsetX)/rect.width)*100;
      let y=((e.clientY-rect.top-offsetY)/rect.height)*100;
      btn.style.left=x+"%";
      btn.style.top=y+"%";
    };
    document.onmouseup = ()=>dragging=false;
    formContainer.appendChild(btn);
  });

  // Footer
  const footer = document.createElement("footer");
  footer.style.textAlign="center";
  footer.style.marginTop="10px";
  footer.style.fontSize="12px";
  footer.textContent = data.footerText;
  formContainer.appendChild(footer);
}
</script>
</body>
</html>
