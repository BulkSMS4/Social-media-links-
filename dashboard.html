<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š Submissions Dashboard</title>
<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;padding:20px}
.container{max-width:1000px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
h2{text-align:center}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #ccc;padding:10px;text-align:left}
th{background:#1976d2;color:#fff}
tr:nth-child(even){background:#f1f1f1}
button{padding:6px 10px;margin:2px;border:none;border-radius:5px;cursor:pointer}
button.copy{background:#4caf50;color:#fff}
button.delete{background:#f44336;color:#fff}
button.selectAll{background:#1976d2;color:#fff}
button.deleteAll{background:#d32f2f;color:#fff}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
<h2>ğŸ“Š Form Submissions Dashboard</h2>
<div>
<button class="selectAll" onclick="selectAll()">Select All âœ…</button>
<button class="deleteAll" onclick="deleteSelected()">Delete Selected ğŸ—‘ï¸</button>
</div>
<table>
<thead>
<tr>
<th>Select</th>
<th>Form ID</th>
<th>Field Name</th>
<th>Value</th>
<th>Time</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="submissionBody"></tbody>
</table>
</div>

<script>
const $ = id => document.getElementById(id);
const firebaseConfig = {
  apiKey: "AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
  authDomain: "usahackersland.firebaseapp.com",
  projectId: "usahackersland"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let selected = new Set();

function renderTable(submissions){
  const tbody = $("submissionBody");
  tbody.innerHTML = "";

  submissions.forEach(doc=>{
    const data = doc.data();
    const formId = data.formId;
    const createdAt = new Date(data.createdAt).toLocaleString();

    Object.entries(data.data).forEach(([field,value])=>{
      const tr = document.createElement("tr");

      const selectTd = document.createElement("td");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.onchange = e=>{
        if(e.target.checked) selected.add(doc.id+"_"+field);
        else selected.delete(doc.id+"_"+field);
      };
      selectTd.appendChild(checkbox);
      tr.appendChild(selectTd);

      const formTd = document.createElement("td");
      formTd.textContent = formId;
      tr.appendChild(formTd);

      const fieldTd = document.createElement("td");
      fieldTd.textContent = field;
      tr.appendChild(fieldTd);

      const valueTd = document.createElement("td");
      valueTd.textContent = value;
      tr.appendChild(valueTd);

      const timeTd = document.createElement("td");
      timeTd.textContent = createdAt;
      tr.appendChild(timeTd);

      const actionTd = document.createElement("td");

      const copyBtn = document.createElement("button");
      copyBtn.textContent = "Copy ğŸ“‹";
      copyBtn.className="copy";
      copyBtn.onclick = ()=>navigator.clipboard.writeText(value);
      actionTd.appendChild(copyBtn);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete ğŸ—‘ï¸";
      deleteBtn.className="delete";
      deleteBtn.onclick = ()=>deleteField(doc.id, field);
      actionTd.appendChild(deleteBtn);

      tr.appendChild(actionTd);

      tbody.appendChild(tr);
    });
  });
}

// Delete single field
function deleteField(docId, field){
  const docRef = db.collection("submissions").doc(docId);
  docRef.get().then(doc=>{
    if(!doc.exists) return;
    const data = doc.data().data;
    delete data[field];
    // if no fields left, delete doc
    if(Object.keys(data).length===0){
      docRef.delete();
    } else {
      docRef.update({data});
    }
  });
}

// Select all checkboxes
function selectAll(){
  document.querySelectorAll("tbody input[type=checkbox]").forEach(cb=>{
    cb.checked=true;
    const tr = cb.closest("tr");
    const docId = tr.children[1].textContent;
    const field = tr.children[2].textContent;
    selected.add(docId+"_"+field);
  });
}

// Delete all selected
function deleteSelected(){
  const arr = Array.from(selected);
  arr.forEach(idField=>{
    const [docId, field] = idField.split("_");
    deleteField(docId, field);
  });
  selected.clear();
}

// Listen to submissions
db.collection("submissions").orderBy("createdAt","desc").onSnapshot(snap=>{
  const submissions = [];
  snap.forEach(doc=>submissions.push(doc));
  renderTable(submissions);
});
</script>
</body>
</html>
