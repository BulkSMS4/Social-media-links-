<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Emergency Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: lime; padding: 20px; }
    h1 { color: red; }
    .form-box { background: #000; padding: 15px; border: 1px solid red; border-radius: 8px; margin-bottom: 20px; }
    input, textarea { width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #555; background: #222; color: #fff; }
    button { padding: 10px 15px; margin: 5px 0; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-post { background: lime; color: black; }
    .btn-delete { background: red; color: white; }
    .post { background: #222; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444; }
    img { max-width: 100%; border-radius: 6px; margin-top: 8px; }
  </style>
</head>
<body>

  <h1>üö® Admin Emergency Messages</h1>

  <!-- Post Form -->
  <div class="form-box">
    <h2>Create New Emergency Post</h2>
    <textarea id="msgText" placeholder="Enter emergency text"></textarea>
    <input type="text" id="msgLink" placeholder="Add link (optional)">
    <input type="text" id="msgNumber" placeholder="Add number (optional)">
    <input type="text" id="msgImageUrl" placeholder="Image URL (optional)">
    <input type="file" id="msgImageFile">
    <button class="btn-post" onclick="postMessage()">Post</button>
  </div>

  <!-- Display Posts -->
  <h2>All Emergency Posts</h2>
  <div id="posts"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
      authDomain: "usahackersland.firebaseapp.com",
      projectId: "usahackersland",
      storageBucket: "usahackersland.appspot.com",
      messagingSenderId: "588407428267",
      appId: "1:588407428267:web:7c4898cbb62efd3d5953ee",
      measurementId: "G-ZJ05T7YNSQ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const ADMIN_UID = "xjsW37kcdzTrdJddHjvhmdpFeV22";

    // Check login
    firebase.auth().onAuthStateChanged(user => {
      if (!user || user.uid !== ADMIN_UID) {
        alert("Access denied. Admins only!");
        document.body.innerHTML = "<h2 style='color:red'>‚õî Not authorized</h2>";
      }
    });

    // Post new message
    async function postMessage() {
      const text = document.getElementById("msgText").value;
      const link = document.getElementById("msgLink").value;
      const number = document.getElementById("msgNumber").value;
      const imageUrlInput = document.getElementById("msgImageUrl").value;
      const imageFile = document.getElementById("msgImageFile").files[0];

      let finalImageUrl = imageUrlInput;

      if (imageFile) {
        const storageRef = storage.ref("emergency/" + Date.now() + "_" + imageFile.name);
        await storageRef.put(imageFile);
        finalImageUrl = await storageRef.getDownloadURL();
      }

      await db.collection("emergency").add({
        text, link, number,
        image: finalImageUrl || "",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      document.getElementById("msgText").value = "";
      document.getElementById("msgLink").value = "";
      document.getElementById("msgNumber").value = "";
      document.getElementById("msgImageUrl").value = "";
      document.getElementById("msgImageFile").value = "";

      alert("‚úÖ Emergency message posted");
    }

    // Load posts in real-time
    const postsBox = document.getElementById("posts");
    db.collection("emergency").orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        postsBox.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          let html = `<div class="post">
                        <p><b>Message:</b> ${data.text || ""}</p>
                        ${data.link ? `<p><b>Link:</b> <a href="${data.link}" target="_blank">${data.link}</a></p>` : ""}
                        ${data.number ? `<p><b>Number:</b> ${data.number}</p>` : ""}
                        ${data.image ? `<img src="${data.image}">` : ""}
                        <button class="btn-delete" onclick="deletePost('${doc.id}')">Delete</button>
                      </div>`;
          postsBox.innerHTML += html;
        });
      });

    // Delete post
    async function deletePost(id) {
      try {
        await db.collection("emergency").doc(id).delete();
        alert("üóëÔ∏è Deleted successfully");
      } catch (err) {
        alert("Error deleting: " + err.message);
      }
    }
  </script>
</body>
</html>
