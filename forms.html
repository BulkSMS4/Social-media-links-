<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Saved Forms</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  body { font-family: Arial; padding: 20px; background: #f9f9f9; }
  h2 { text-align: center; }

  .form-card {
    background: white;
    padding: 15px;
    margin: 10px auto;
    max-width: 700px;
    border-radius: 8px;
    box-shadow: 0 0 5px #ccc;
  }

  .actions button {
    margin: 5px;
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  .actions button:hover { opacity: 0.8; }

  .preview-img {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 5px;
    margin-top: 10px;
  }
</style>
</head>
<body>

<h2>ğŸ’¾ Saved Forms</h2>
<div id="formsList"></div>  

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
  authDomain: "usahackersland.firebaseapp.com",
  projectId: "usahackersland",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const formsList = document.getElementById("formsList");

// --- LIVE UPDATE SNAPSHOT ---
db.collection("forms")
  .orderBy("createdAt", "desc")
  .onSnapshot(snapshot => {
    formsList.innerHTML = "";
    snapshot.forEach(doc => renderForm(doc));
  });

// --- RENDER SINGLE FORM CARD ---
function renderForm(doc) {
  const form = doc.data();

  // âœ… Links match form.html preview
  const viewLink = `${location.origin}/form.html?id=${doc.id}`;
  const editLink = `${location.origin}/build.html?edit=${doc.id}`;

  const div = document.createElement("div");
  div.className = "form-card";

  div.innerHTML = `
    <input value="${form.title || "Untitled Form"}"
           onchange="saveTitle(this, '${doc.id}')"
           style="font-size:18px; width:100%; font-weight:bold; padding:5px; border:none; background:#eef;">

    <p><strong>Created:</strong> ${new Date(form.createdAt).toLocaleString()}</p>

    <p>
      <strong>Link:</strong>
      <input type="text" value="${viewLink}" readonly style="width:80%;">
      <button onclick="copyLink('${viewLink}')">ğŸ“‹ Copy</button>
    </p>

    ${form.bannerURL ? `<img src="${form.bannerURL}" class="preview-img" />` : ""}

    <div class="actions">
      <button onclick="viewForm('${viewLink}')">ğŸ‘ï¸ View</button>
      <button onclick="editForm('${editLink}')">âœï¸ Edit</button>
      <button onclick="deleteForm('${doc.id}', this)">ğŸ—‘ï¸ Delete</button>
      <button onclick="downloadForm('${doc.id}')">â¬‡ï¸ Download</button>
    </div>
  `;

  formsList.appendChild(div);
}

// --- HELPER FUNCTIONS ---
function saveTitle(input, id) {
  db.collection("forms").doc(id).update({ title: input.value })
    .then(() => console.log("Title saved"))
    .catch(err => alert("Failed to save: " + err));
}

function copyLink(link) {
  navigator.clipboard.writeText(link);
  alert("Copied!");
}

function viewForm(link) { window.open(link, "_blank"); }
function editForm(link) { window.open(link, "_blank"); }

function deleteForm(id, btn) {
  if(!confirm("Delete this form?")) return;
  db.collection("forms").doc(id).delete()
    .then(() => btn.closest(".form-card").remove());
}

function downloadForm(id) {
  db.collection("forms").doc(id).get().then(doc => {
    const data = doc.data();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `form_${id}.json`;
    a.click();
  });
}
</script>
</body>
</html>
