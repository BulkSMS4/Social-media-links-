<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Saved Forms</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    h2 { text-align: center; }
    .form-card { background: white; padding: 15px; margin: 10px auto; max-width: 700px; border-radius: 8px; box-shadow: 0 0 5px #ccc; }
    .actions button { margin: 5px; padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; }
    .actions button:hover { opacity: 0.8; }
    .preview-img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 5px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üíæ Saved Forms</h2>
  <div id="formsList"></div>  

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB5zWUvl64s6wAjjeXd0mCUyhMEdzg_MmM",
  authDomain: "usahackersland.firebaseapp.com",
  projectId: "usahackersland",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const list = document.getElementById("formsList");
const formCards = {};

function renderForm(doc) {
  const form = doc.data();
  const viewLink = `${location.origin}/public/form.html?id=${doc.id}`;
  const editLink = `${location.origin}/public/build.html?edit=${doc.id}`;

  let div = formCards[doc.id];
  if(!div) {
    div = document.createElement("div");
    div.className = "form-card";
    div.id = `form-${doc.id}`;
    formCards[doc.id] = div;
    list.prepend(div);
  }

  div.innerHTML = `
    <input value="${form.title || "Untitled Form"}"
           onchange="saveTitle(this,'${doc.id}')"
           style="font-size:18px; width:100%; font-weight:bold; padding:5px; border:none; background:#eef;">
    <p><strong>Created:</strong> ${new Date(form.createdAt).toLocaleString()}</p>
    <p><strong>Link:</strong> <input type="text" value="${viewLink}" readonly style="width:80%;"><button onclick="copyLink('${viewLink}')">üìã Copy</button></p>
    ${form.bannerURL ? `<img src="${form.bannerURL}" class="preview-img" />` : ""}
    <div class="actions">
      <button onclick="viewForm('${viewLink}')">üëÅÔ∏è View</button>
      <button onclick="editForm('${editLink}')">‚úèÔ∏è Edit</button>
      <button onclick="deleteForm('${doc.id}')">üóëÔ∏è Delete</button>
      <button onclick="downloadForm('${doc.id}')">‚¨áÔ∏è Download</button>
    </div>
  `;
}

function removeForm(docId) {
  const div = formCards[docId];
  if(div) { div.remove(); delete formCards[docId]; }
}

// --- LIVE FIRESTORE LISTENER ---
db.collection("forms").orderBy("createdAt","desc")
  .onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      if(change.type==="added" || change.type==="modified") renderForm(change.doc);
      if(change.type==="removed") removeForm(change.doc.id);
    });
  });

// --- BUTTON FUNCTIONS ---
function saveTitle(input, id){ db.collection("forms").doc(id).update({title: input.value}); }
function copyLink(link){ navigator.clipboard.writeText(link); alert("Copied!"); }
function viewForm(link){ window.open(link,"_blank"); }
function editForm(link){ window.open(link,"_blank"); }
function deleteForm(id){ if(confirm("Delete this form?")) db.collection("forms").doc(id).delete(); }
function downloadForm(id){
  db.collection("forms").doc(id).get().then(doc=>{
    const blob = new Blob([JSON.stringify(doc.data(),null,2)], {type:'application/json'});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `form_${id}.json`;
    a.click();
  });
}
</script>
</body>
</html>
